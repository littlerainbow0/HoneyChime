<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/src/assets/css/header.css">
    <link rel="stylesheet" href="/src/assets/css/reservation.css">
    <link rel="stylesheet" href="/src/assets/css/top_btn.css">
    <!-- 引入 Flatpickr 的 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- 引入 Flatpickr 的 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <title>預約行程</title>
</head>

<body class="reservation">
    <header class="reservation_hero">
        <div class="header_logo">
            <a href="#">
                <img src="/src/assets/images/icon/LOGO.svg" alt="">
            </a>
            <a href="">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M20 22H4v-2a5 5 0 0 1 5-5h6a5 5 0 0 1 5 5zm-8-9a6 6 0 1 1 0-12a6 6 0 0 1 0 12" />
                </svg>
            </a>
        </div>

        <nav class="header_nav">
            <ul>
                <li><a href="">首頁</a></li>
                <li><a href="">概念</a></li>
                <li><a href="">饗宴</a></li>
                <li><a href="/facilities.html">設施</a></li>
                <li><a href="/trip.html">旅程</a></li>
            </ul>
        </nav>
    </header>
    <!-- 上方訂單需求 -->
    <form action="">
        <div class="form_apply">

            <div>
                <label for="dessert_type">主題甜點：</label>
                <select name="" id="dessert_type">
                    <option value="jp">日式甜點</option>
                    <option value="tw">台式甜點</option>
                    <option value="eu">歐式甜點</option>
                </select>

            </div>

            <div>
                <label for="people">旅客人數：</label>
                <select name="" id="people">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>

            <div>
                <label for="departure_date">出發日期：</label>
                <input type="date" name="" id="departure_date" placeholder="選擇日期">
            </div>

            <div>
                <label for="departure_time">出發時間：</label>
                <select name="" id="departure_time">
                    <option value="13:00">13:00</option>
                    <option value="17:00">17:00</option>
                </select>
            </div>

            <div>
                <label for="route_start">起站：</label>
                <select name="" id="route_start">
                    <option value="0">請選擇站點</option>
                    <option value="2">台北</option>
                    <option value="3">台中</option>
                    <option value="1">台南</option>
                    <option value="5">高雄</option>
                    <option value="4">花蓮</option>
                </select>
            </div>
            <div>
                <label for="route_end">迄站：</label>
                <select name="" id="route_end">
                    <option value="0">請選擇站點</option>
                    <option value="2">台北</option>
                    <option value="3">台中</option>
                    <option value="1">台南</option>
                    <option value="5">高雄</option>
                    <option value="4">花蓮</option>
                </select>
            </div>
        </div>

        <div class="form_seat">
            <div class="seat_title">
                <div>
                    <label for="car_type">車廂類型：</label>
                    <select name="" id="car_type">
                        <option value="f">景觀車廂Ｆ - 雙人座</option>
                        <option value="e">景觀車廂Ｅ - 四人座</option>
                        <option value="d">景觀車廂Ｄ - 雙人包廂</option>
                        <option value="a">豪華景觀車廂Ａ - VIP 四人席</option>
                    </select>
                </div>
                <div>
                    <label for="seat">座位：</label>
                    <select name="" id="seat">
                        <option value="0">請選擇座位</option>
                        <option value="f1">F1</option>
                        <option value="f2">F2</option>
                        <option value="f3">F3</option>
                        <option value="f4">F4</option>
                        <option value="f5">F5</option>
                        <option value="f6">F6</option>
                        <option value="f7">F7</option>
                        <option value="f8">F8</option>
                    </select>
                </div>
            </div>
            <div class="seat_img">
                <p>車廂示意圖</p>
                <object id="car_image" data="/src/assets/images/plan/F.svg">
                </object>
            </div>
        </div>

    </form>
    <!-- 上方應單需求結束 -->

    <!-- 中間訂單內容 -->
    <div class="order_list">
        <!-- 左側訂單內容 -->
        <div class="trip_detail">

            <div>
                <h6>
                    行程
                </h6>
                <div>
                    <img src="/src/assets/images/train_exterior/tripInfo_train01.png" alt="">
                    <p>台北⭢台中</p>
                </div>
            </div>

            <div>
                <h6>
                    選擇餐點
                </h6>
                <div>
                    <div>
                        <img src="/src/assets/images/dessert/trip_Jp.png" alt="">
                        <label for="dessert_jpA_qty">
                            套餐名稱：<span id="dessert_title1">舒芙蕾套餐</span>
                            <br>
                            <span>套餐內容：舒芙蕾, 抹茶</span>
                        </label>
                        <select name="" id="dessert_jpA_qty">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>

                    <div>
                        <img src="/src/assets/images/dessert/tripInfo_Jp02.png" alt="">
                        <label for="dessert_jpB_qty">
                            套餐名稱：<span id="dessert_title2">日式和菓子</span>
                            <br>
                            <span>套餐內容：日式和菓子, 煎茶</span>
                        </label>
                        <select name="" id="dessert_jpB_qty">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!-- 左側訂單內容結束 -->

        <!-- 右側訂單明細 -->
        <div class="order_detail">
            <p>您的預約 - 蜂鳴號</p>
            <p>
                <span>路線</span>
                <span id="order_route"></span>
            </p>
            <p>
                <span>出發時間</span>
                <span id="order_start_date"></span>
            </p>
            <p>
                <span>抵達時間</span>
                <span id="order_arrive_date"></span>
            </p>
            <p>
                <span>乘客人數</span>
                <span id="order_people">
                </span>
            </p>
            <p>
                <span>車廂</span>
                <span id="order_car"></span>
            </p>
            <p>
                <span>座位</span>
                <span id="order_seat"></span>
            </p>
            <p>
                <span>餐點</span>
                <span id="order_dessert"> 日式舒芙蕾套餐*1, <br>
                    日式菓子套餐*1</span>
            </p>
            <p>
                <span>金額</span>
                <span id="order_price">$4000</span>
            </p>
        </div>
        <!-- 右側訂單明細結束 -->

    </div>
    <!-- 訂單資訊結束 -->

    <!-- 訂位人資料 -->
    <div class="user_info">
        <h6>訂位人資料</h6>
        <label for="lastName">姓名</label>
        <br>
        <input type="text" id="Name" placeholder="請輸入姓名" minlength="2" required>
        <span class="error"></span>

        <br>
        <label for="phone">手機號碼</label>
        <br>
        <input type="tel" id="phone" pattern="09[0-9]{10}" placeholder="請輸入手機號碼" required>
        <span class="error"></span>
        <br>
        <label for="email">電子郵件</label>
        <br>
        <input type="email" id="email" placeholder="請輸入電子郵件" required>
        <span class="error"></span>

        <br>
        <label for="creditCard">信用卡號</label>
        <br>
        <input type="text" id="creditCard" pattern="[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{4}"
            placeholder="xxxx-xxxx-xxxx-xxxx" required>
        <span class="error"></span>

        <button type="submit" onclick="userInfoCheck()" id="complete">下一步</button>
    </div>
    <!-- 訂位人資料結束 -->

    <a href="#" class="top">
        Λ
        <br>
        Top
    </a>
    <script>

        // -------------------------------------------
        const scheduleData =
            [
                {
                    SchedulesID: 1,
                    DepartureDate: "2024-10-10",
                    DepartureTime: "13:00",
                    RouteStart: "台北",
                    RouteEnd: "台中",
                    Duration: 121,
                },
                {
                    SchedulesID: 2,
                    DepartureDate: "2024-10-10",
                    DepartureTime: "17:00",
                    RouteStart: "台北",
                    RouteEnd: "台中",
                    Duration: 121
                },
                {
                    SchedulesID: 3,
                    DepartureDate: "2025-11-14",
                    DepartureTime: "13:00",
                    RouteStart: "台北",
                    RouteEnd: "台中",
                    Duration: 121
                },
                {
                    SchedulesID: 4,
                    DepartureDate: "2025-11-14",
                    DepartureTime: "17:00",
                    RouteStart: "台北",
                    RouteEnd: "台中",
                    Duration: 121
                },
                {
                    SchedulesID: 5,
                    DepartureDate: "2025-11-14",
                    DepartureTime: "13:00",
                    RouteStart: "台北",
                    RouteEnd: "花蓮",
                    Duration: 150
                }

                //用日期去判斷日曆能點擊的部分(有行程且時間是未來)
            ]

        // 抓日曆去選擇出發時間、起站、迄站與抵達時間
        document.addEventListener('DOMContentLoaded', () => {
            const departureTimeSelect = document.getElementById('departure_time');
            const orderStartDate = document.getElementById('order_start_date');
            const orderArriveDate = document.getElementById('order_arrive_date');
            const routeStartSelect = document.getElementById('route_start');
            const routeEndSelect = document.getElementById('route_end');

            // 提取可用日期
            const availableDates = scheduleData.map(schedule => schedule.DepartureDate);

            // 初始化 Flatpickr
            flatpickr("#departure_date", {
                dateFormat: "Y-m-d",
                enable: availableDates,
                disable: [
                    function (date) {
                        return !availableDates.includes(date.toISOString().split('T')[0]);
                    }
                ],
                onChange: function (selectedDates, dateStr) {
                    setDepartureDetails(dateStr);
                }
            });

            // 設置出發詳情
            const setDepartureDetails = (selectedDate) => {
                const selectedTime = departureTimeSelect.value;

                // 查找匹配的排程
                const schedule = scheduleData.find(s => s.DepartureDate === selectedDate && s.DepartureTime === selectedTime);

                if (schedule) {
                    orderStartDate.textContent = `${schedule.DepartureDate} ${schedule.DepartureTime}`;
                    // 更新起站和迄站選項
                    updateRouteOptions(selectedDate, selectedTime);
                } else {
                    orderStartDate.textContent = "無可用排程";
                    orderArriveDate.textContent = ""; // 清空抵達時間
                    clearRouteOptions();
                }
            };

            // 計算抵達時間
            function calculateArrivalTime(departureTime, duration) {
                const [hours, minutes] = departureTime.split(':').map(Number);
                const departureDateTime = new Date();
                departureDateTime.setHours(hours);
                departureDateTime.setMinutes(minutes);

                // 加上持續時間
                departureDateTime.setMinutes(departureDateTime.getMinutes() + duration);

                const arrivalHours = departureDateTime.getHours().toString().padStart(2, '0');
                const arrivalMinutes = departureDateTime.getMinutes().toString().padStart(2, '0');

                return `${arrivalHours}:${arrivalMinutes}`;
            }

            // 更新路線選項
            function updateRouteOptions(selectedDate, selectedTime) {
                // 清空選項
                clearRouteOptions();

                // 收集所有起站和迄站
                const routes = scheduleData.filter(schedule => schedule.DepartureDate === selectedDate && schedule.DepartureTime === selectedTime);

                const startRoutes = new Set();
                const endRoutes = new Set();

                routes.forEach(route => {
                    startRoutes.add(route.RouteStart);
                    endRoutes.add(route.RouteEnd);
                });

                // 更新起站選項
                startRoutes.forEach(route => {
                    routeStartSelect.innerHTML += `<option value="${route}">${route}</option>`;
                });

                // 更新迄站選項
                endRoutes.forEach(route => {
                    routeEndSelect.innerHTML += `<option value="${route}">${route}</option>`;
                });

                // 添加監聽器到迄站選擇
                routeEndSelect.addEventListener('change', () => {
                    const selectedRouteEnd = routeEndSelect.value;
                    const schedule = routes.find(s => s.RouteEnd === selectedRouteEnd);

                    if (schedule) {
                        const arrivalTime = calculateArrivalTime(schedule.DepartureTime, schedule.Duration);
                        orderArriveDate.textContent = arrivalTime;
                    } else {
                        orderArriveDate.textContent = ""; // 清空抵達時間
                    }
                });
            }

            // 清空路線選項
            function clearRouteOptions() {
                routeStartSelect.innerHTML = `<option value="0">請選擇站點</option>`;
                routeEndSelect.innerHTML = `<option value="0">請選擇站點</option>`;
            }

            // 監聽出發時間變化事件
            departureTimeSelect.addEventListener('change', () => {
                const selectedDate = document.getElementById('departure_date').value;
                setDepartureDetails(selectedDate);
            });

            // 監聽出發日期變化事件
            document.getElementById('departure_date').addEventListener('change', (event) => {
                setDepartureDetails(event.target.value);
            });
        });



        // ----------- order detail 抓客人填寫的資料 ------------
        function updateOrderDetail() {
            // 更新日期、人數
            document.getElementById("order_people").innerHTML = document.getElementById("people").value + "人";
            document.getElementById("order_start_date").innerHTML = document.getElementById("departure_date").value + " , " + document.getElementById("departure_time").value;
            let arriveTime = document.getElementById("order_arrive_date").innerHTML;

            let totalPrice = document.getElementById("order_price").innerHTML;
            // 更新座位
            let seat = document.getElementById("seat").value;
            let orderSeat;
            if (seat.startsWith('f')) {
                orderSeat = seat.replace('f', "F");
            } if (seat.startsWith('f')) {
                orderSeat = seat.replace('f', 'F');
            } else if (seat.startsWith('e')) {
                orderSeat = seat.replace('e', 'E');
            } else if (seat.startsWith('d')) {
                orderSeat = seat.replace('d', 'D');
            } else if (seat.startsWith('a')) {
                orderSeat = seat.replace('a', 'A');
            } else {
                orderSeat = seat; // 如果是其他值則原樣顯示
            }
            document.getElementById("order_seat").innerHTML = orderSeat;

            // 更新車廂類型
            let carType = document.getElementById("car_type").value;
            let orderCar;

            switch (carType) {
                case 'f':
                    orderCar = "景觀車廂Ｆ - 雙人座";
                    break;
                case 'e':
                    orderCar = "景觀車廂Ｅ - 四人座";
                    break;
                case 'd':
                    orderCar = "景觀車廂Ｄ - 雙人包廂";
                    break;
                case 'a':
                    orderCar = "豪華景觀車廂Ａ - VIP 四人席";
                    break;
                default:
                    orderCar = "";
            }

            // 將 orderCar 更新到對應的 HTML 元素
            document.getElementById("order_car").innerHTML = orderCar;

        }

        document.querySelectorAll('.form_apply select, .form_apply input, .form_seat select').forEach(element => {
            element.addEventListener('change', updateOrderDetail);
        })


        // 更新路線
        document.addEventListener('DOMContentLoaded', () => {
            const routeStart = document.getElementById("route_start");
            const routeEnd = document.getElementById("route_end");
            const orderRoute = document.getElementById("order_route");

            const updateRoute = () => {
                const start = routeStart.options[routeStart.selectedIndex].text;
                const end = routeEnd.options[routeEnd.selectedIndex].text;
                if (routeStart.value !== "0" && routeEnd.value !== "0") {
                    orderRoute.textContent = `${start} ⭢ ${end}`;
                } else {
                    orderRoute.textContent = "";
                }
            };
            routeStart.addEventListener('change', updateRoute);
            routeEnd.addEventListener('change', updateRoute);
        });



        // ----- 車廂選項綁定車廂座位與車廂圖片 -----
        document.getElementById('car_type').addEventListener('change', function () {
            var seatSelect = document.getElementById('seat');
            var carImage = document.getElementById('car_image');

            // 清空座位選項
            seatSelect.innerHTML = '';

            if (this.value === 'e') {
                seatSelect.innerHTML += '<option value="0">請選擇座位</option>';
                seatSelect.innerHTML += '<option value="e1">E2</option>';
                seatSelect.innerHTML += '<option value="e2">E3</option>';
                seatSelect.innerHTML += '<option value="e3">E4</option>';
                carImage.data = '/src/assets/images/plan/E.svg';
            } else if (this.value === 'd') {
                seatSelect.innerHTML += '<option value="0">請選擇座位</option>';
                seatSelect.innerHTML += '<option value="d1">D1</option>';
                seatSelect.innerHTML += '<option value="d2">D2</option>';
                seatSelect.innerHTML += '<option value="d3">D3</option>';
                seatSelect.innerHTML += '<option value="d4">D4</option>';
                seatSelect.innerHTML += '<option value="d5">D5</option>';
                seatSelect.innerHTML += '<option value="d6">D6</option>';
                carImage.data = '/src/assets/images/plan/D.svg';

            } else if (this.value === 'a') {
                seatSelect.innerHTML += '<option value="0">請選擇座位</option>';
                seatSelect.innerHTML += '<option value="a1">A1</option>';
                carImage.data = '/src/assets/images/plan/A.svg';

            }

            else if (this.value === 'f') {
                // 還原到原始選項
                seatSelect.innerHTML += '<option value="0">請選擇座位</option>';
                seatSelect.innerHTML += '<option value="f1">F1</option>';
                seatSelect.innerHTML += '<option value="f2">F2</option>';
                seatSelect.innerHTML += '<option value="f3">F3</option>';
                seatSelect.innerHTML += '<option value="f4">F4</option>';
                seatSelect.innerHTML += '<option value="f5">F5</option>';
                seatSelect.innerHTML += '<option value="f6">F6</option>';
                seatSelect.innerHTML += '<option value="f7">F7</option>';
                seatSelect.innerHTML += '<option value="f8">F8</option>';
                carImage.data = '/src/assets/images/plan/F.svg';
            }
        });

        // -------------------------------------------
        // 甜點數量綁定人數
        document.addEventListener('DOMContentLoaded', function () {
            const dessertA = document.getElementById('dessert_jpA_qty');
            const dessertB = document.getElementById('dessert_jpB_qty');
            const people = document.getElementById('people');

            function updateDessertAOptions() {
                // 清空 dessertA 的選項
                dessertA.innerHTML = '';

                // 根據 people 的值添加選項到 dessertA
                const peopleCount = parseInt(people.value);

                for (let i = 0; i <= peopleCount; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    dessertA.appendChild(option);
                }

                // 更新 dessertB 的選項
                updateDessertBOptions();
            }

            function updateDessertBOptions() {
                const peopleCount = parseInt(people.value);
                const dessertAValue = parseInt(dessertA.value);

                // 計算 dessertB 的最大可選數量
                const maxDessertBValue = peopleCount - dessertAValue;

                // 清空 dessertB 的選項
                dessertB.innerHTML = '';

                // 根據計算出的最大值添加選項
                for (let i = 0; i <= maxDessertBValue; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    dessertB.appendChild(option);
                }
            }

            // 監聽 people 的選擇項改變事件
            people.addEventListener('change', updateDessertAOptions);

            // 監聽 dessertA 的選擇項改變事件
            dessertA.addEventListener('change', updateDessertBOptions);

            // 初始化選項
            updateDessertAOptions();
        });


        // ---------------------------------------------------
        // 訂位資料判斷
        function userInfoCheck(event) {

            // 取得輸入框
            const name = document.getElementById('Name');
            const phone = document.getElementById('phone');
            const email = document.getElementById('email');
            const creditCard = document.getElementById('creditCard');

            // 清除之前的錯誤信息
            document.querySelectorAll('.error').forEach(span => {
                // span.textContent = ''; // 清空文本
                span.classList.remove('active'); // 隱藏錯誤提示
            });

            let isValid = true;

            // 驗證姓名
            if (name.value.trim() === '' || name.value.length < 2) {
                const errorSpan = name.nextElementSibling;
                errorSpan.textContent = '請輸入有效姓名！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            // 驗證手機號碼
            if (!phone.value.match(/^09[0-9]{8}$/)) {
                const errorSpan = phone.nextElementSibling;
                errorSpan.textContent = '請輸入有效的手機號碼！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            // 驗證電子郵件
            if (!email.value.match(/^[^@\s]+@[^@\s]+\.[^@\s]+$/)) {
                const errorSpan = email.nextElementSibling;
                errorSpan.textContent = '請輸入有效的電子郵件！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            // 驗證信用卡號
            if (!creditCard.value.match(/^[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{4}$/)) {
                const errorSpan = creditCard.nextElementSibling;
                errorSpan.textContent = '請輸入有效的信用卡號！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            if (isValid) {
                console.log('輸入正確');
                // window.location.href = 'order.html';
            } else {
                console.log('輸入錯誤');

            }
        };
    </script>


</body>

</html>