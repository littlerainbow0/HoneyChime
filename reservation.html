<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/src/assets/css/header_html.css">
    <link rel="stylesheet" href="/src/assets/css/reservation.css">
    <link rel="stylesheet" href="/src/assets/css/top_btn.css">
    <!-- 引入 Flatpickr 的 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- 引入 Flatpickr 的 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>

    <title>預約行程</title>
</head>

<body class="reservation">
    <header class="reservation_hero">
        <nav class="header_nav">
            <div class="header_logo">
                <a href="/" class="logo">
                    <img src="/src/assets/images/icon/LOGO.svg" alt="">
                </a>
                <a href="/login" class="member_icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M20 22H4v-2a5 5 0 0 1 5-5h6a5 5 0 0 1 5 5zm-8-9a6 6 0 1 1 0-12a6 6 0 0 1 0 12" />
                    </svg>
                </a>
            </div>
            <ul>
                <li><a href="/">首頁</a></li>
                <li><a href="/about">概念</a></li>
                <li><a href="/menu">饗宴</a></li>
                <li><a href="/facilities">設施</a></li>
                <li><a href="/trip">旅程</a></li>
            </ul>
        </nav>
    </header>
    <!-- 上方訂單需求 -->
    <form action="">
        <div class="form_apply">

            <div>
                <label for="dessert_type">主題甜點：</label>
                <select name="" id="dessert_type">
                    <option value="jp">日式甜點</option>
                    <option value="tw">台式甜點</option>
                    <option value="eu">歐式甜點</option>
                </select>

            </div>

            <div>
                <label for="people">旅客人數：</label>
                <select name="" id="people">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>

            <div>
                <label for="departure_date">出發日期：</label>
                <input type="date" name="" id="departure_date" placeholder="選擇日期">
            </div>

            <div>
                <label for="departure_time">出發時間：</label>
                <select name="" id="departure_time">
                    <option value="0">選擇出發時間</option>
                    <option value="13:00">13:00</option>
                    <option value="17:00">17:00</option>
                </select>
            </div>

            <div>
                <label for="route_start">起站：</label>
                <select name="" id="route_start">
                    <option value="0">請選擇站點</option>

                </select>
            </div>
            <div>
                <label for="route_end">迄站：</label>
                <select name="" id="route_end">
                    <option value="0">請選擇站點</option>

                </select>
            </div>
        </div>

        <div class="form_seat">
            <div class="seat_title">
                <div>
                    <label for="car_type">車廂類型：</label>
                    <select name="" id="car_type">

                    </select>
                </div>
                <div>
                    <label for="seat">座位：</label>
                    <select name="" id="seat">
                        <option value="0">請選擇座位</option>

                    </select>
                </div>
            </div>
            <div class="seat_img">
                <p>車廂示意圖</p>
                <object id="car_image" data="./src/assets/images/plan/F.svg">
                </object>
            </div>
        </div>

    </form>
    <!-- 上方應單需求結束 -->

    <!-- 中間訂單內容 -->
    <div class="order_list">
        <!-- 左側訂單內容 -->
        <div class="trip_detail">

            <div>
                <h6>
                    行程
                </h6>
                <div>
                    <img id="tripRouteImg" src="/src/assets/images/train_exterior/tripInfo_train01.png" alt="">
                    <p id="tripRoute">台北⭢台中</p>
                </div>
            </div>

            <div>
                <h6>
                    選擇餐點
                </h6>
                <div>
                    <div>
                        <img id="dessert_img1" src="/src/assets/images/dessert/dessert_newDessert.jpg" alt="">
                        <label for="dessert_jpA_qty">
                            套餐名稱：<span id="dessert_title1">舒芙蕾佐時令水果</span>
                            <br>
                            套餐內容：<span id="dessert_content1">舒芙蕾, 時令水果, 日本綠茶</span>
                        </label>
                        <select name="" id="dessert_jpA_qty">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>

                    <div>
                        <img id="dessert_img2" src="/src/assets/images/dessert/tripInfo_Jp02.png" alt="">
                        <label for="dessert_jpB_qty">
                            套餐名稱：<span id="dessert_title2">日式和菓子佐綠茶羊羹</span>
                            <br>
                            套餐內容：<span id="dessert_content2">日式和菓子, 綠茶羊羹, 靜岡抹茶</span>
                        </label>
                        <select name="" id="dessert_jpB_qty">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!-- 左側訂單內容結束 -->

        <!-- 右側訂單明細 -->
        <div class="order_detail">
            <p>您的預約 - 蜂鳴號</p>
            <p>
                <span>路線</span>
                <span id="order_route"></span>
            </p>
            <p>
                <span>出發時間</span>
                <span id="order_start_date"></span>
            </p>
            <p>
                <span>抵達時間</span>
                <span id="order_arrive_date"></span>
            </p>
            <p>
                <span>乘客人數</span>
                <span id="order_people">
                </span>
            </p>
            <p>
                <span>車廂</span>
                <span id="order_car"></span>
            </p>
            <p>
                <span>座位</span>
                <span id="order_seat"></span>
            </p>
            <p>
                <span>餐點</span>
                <span>
                    <span id="order_dessert1"> </span>
                    <br>
                    <span id="order_dessert2"> </span>
                </span>

            </p>
            <p>
                <span>金額</span>
                <span id="order_price">$0</span>
            </p>
        </div>
        <!-- 右側訂單明細結束 -->

    </div>
    <!-- 訂單資訊結束 -->

    <!-- 訂位人資料 -->
    <div class="user_info">
        <h6>訂位人資料</h6>
        <label for="lastName">姓名</label>
        <br>
        <input type="text" id="Name" placeholder="請輸入姓名" minlength="2" value="HsingHui" required>
        <span class="error"></span>

        <br>
        <label for="phone">手機號碼</label>
        <br>
        <input type="tel" id="phone" pattern="09[0-9]{10}" placeholder="請輸入手機號碼" value="0987364923" required>
        <span class="error"></span>
        <br>
        <label for="email">電子郵件</label>
        <br>
        <input type="email" id="email" placeholder="請輸入電子郵件" value="user@gmail.com" required>
        <span class="error"></span>

        <br>
        <label for="creditCard">信用卡號</label>
        <br>
        <input type="text" id="creditCard" pattern="[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{4}"
            placeholder="xxxx-xxxx-xxxx-xxxx" value="3202-2222-3333-1014" required>
        <span class="error"></span>

        <button type="submit" onclick="userInfoCheck()" id="complete">下一步</button>
    </div>
    <!-- 訂位人資料結束 -->

    <a href="#" class="top">
      
        Top
    </a>
    <script>
let bookedSeats = []; // 已預訂的座位列表

function getCarSeat() {
    let date = document.getElementById('departure_date').value.replace('/', '-');
    let time = document.getElementById('departure_time').value;
    let stopStart = document.getElementById('route_start').value;
    let stopEnd = document.getElementById('route_end').value;

    axios.get('http://localhost:8000/getOrders')
    .then((response) => {
        let res = response.data;
        // console.log("get schedule", res);

        // 找到符合條件的預訂
        let foundSeat = res.filter(schedule =>
            date === schedule.DepartureDate &&
            time === schedule.DepartureTime &&
            stopStart === schedule.StopStartName &&
            stopEnd === schedule.StopEndName
        );

        // 更新已預訂座位列表
        bookedSeats = foundSeat.map(schedule => schedule.SeatName);

        if (foundSeat.length > 0) {
            foundSeat.forEach(schedule => {
                console.log("此座位已被預訂 ", schedule.SeatName);
            });
        } else {
            console.log("沒有被預訂");
        }

        // 更新座位選項
        updateSeatOptions();
    })
    .catch((error) => { console.log(error.response.data.message); });
}

// 更新座位選項的函數
function updateSeatOptions() {
    const carTypeSelect = document.getElementById('car_type');
    const seatSelect = document.getElementById('seat');
    const carImage = document.getElementById('car_image');

    // 清空座位選項
    seatSelect.innerHTML = '';
    seatSelect.innerHTML += '<option value="0">請選擇座位</option>';

    if (carTypeSelect.value === 'e') {
        carImage.data = '/src/assets/images/plan/E.svg';
        ['E2', 'E3', 'E4'].forEach(seat => {
            if (!bookedSeats.includes(seat)) {
                seatSelect.innerHTML += `<option value="${seat}">${seat}</option>`;
            }
        });
    } else if (carTypeSelect.value === 'd') {
        carImage.data = '/src/assets/images/plan/D.svg';
        ['D1', 'D2', 'D3', 'D4', 'D5', 'D6'].forEach(seat => {
            if (!bookedSeats.includes(seat)) {
                seatSelect.innerHTML += `<option value="${seat}">${seat}</option>`;
            }
        });
    } else if (carTypeSelect.value === 'a') {
        carImage.data = '/src/assets/images/plan/A.svg';
        ['A1'].forEach(seat => {
            if (!bookedSeats.includes(seat)) {
                seatSelect.innerHTML += `<option value="${seat}">${seat}</option>`;
            }
        });
    } else if (carTypeSelect.value === 'f') {
        carImage.data = '/src/assets/images/plan/F.svg';
        ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8'].forEach(seat => {
            if (!bookedSeats.includes(seat)) {
                seatSelect.innerHTML += `<option value="${seat}">${seat}</option>`;
            }
        });
    }
}

// 當車型改變時更新座位選項
document.getElementById('car_type').addEventListener('change', updateSeatOptions);

// 監聽出發日期、時間及路線改變
document.getElementById('departure_date').addEventListener('change', getCarSeat);
document.getElementById('departure_time').addEventListener('change', getCarSeat);
document.getElementById('route_start').addEventListener('change', getCarSeat);
document.getElementById('route_end').addEventListener('change', getCarSeat);

// 初始獲取座位資訊
getCarSeat();





        // 選擇起站與迄站改變 - 行程 - 中的圖片與 起點 ⭢ 終點
        const routeStart = document.getElementById('route_start');
        const routeEnd = document.getElementById('route_end');
        const tripImg = document.getElementById('tripRouteImg');
        const tripRoute = document.getElementById('tripRoute');
        function updateTripDetail() {
            if (routeStart.value == "台北" && routeEnd.value == "台中") {
                tripImg.src = '/src/assets/images/train_exterior/tripInfo_train01.png';
                tripRoute.textContent = `${routeStart.value} ⭢ ${routeEnd.value}`;
            } else if (routeStart.value == "台北" && routeEnd.value == "花蓮") {
                tripImg.src = '/src/assets/images/train_exterior/Facilities_train.png';
                tripRoute.textContent = `${routeStart.value} ⭢ ${routeEnd.value}`;
            } else if (routeStart.value == "台中" && routeEnd.value == "台南") {
                tripImg.src = '/src/assets/images/train_exterior/tripInfo_MountainSm03.png';
                tripRoute.textContent = `${routeStart.value} ⭢ ${routeEnd.value}`;
            } else if (routeStart.value == "台中" && routeEnd.value == "高雄") {
                tripImg.src = '/src/assets/images/train_exterior/train_exterior_4.png';
                tripRoute.textContent = `${routeStart.value} ⭢ ${routeEnd.value}`;
            } else if (routeStart.value == "高雄" && routeEnd.value == "台中") {
                tripImg.src = '/src/assets/images/train_exterior/train_exterior_hero.png';
                tripRoute.textContent = `${routeStart.value} ⭢ ${routeEnd.value}`;
            } else if (routeStart.value == "高雄" && routeEnd.value == "花蓮") {
                tripImg.src = '/src/assets/images/train_exterior/train_exterior_7.png';
                tripRoute.textContent = `${routeStart.value} ⭢ ${routeEnd.value}`;
            }
        }
        routeStart.addEventListener('change', updateTripDetail);
        routeEnd.addEventListener('change', updateTripDetail);


        // ------------ 抓到路線 ------------
        let tripInfoData = JSON.parse(localStorage.getItem("routeType"));
        let start = tripInfoData.start;
        let end = tripInfoData.end;
        let img = tripInfoData.image;
        console.log(start, " ⭢ ", end);
        console.log(img);

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('tripRoute').innerText = `${start} ⭢ ${end}`;
            document.getElementById('tripRouteImg').src = img;
        });




        // -------- 旅客人數與車廂選項邏輯 ---------
        document.addEventListener('DOMContentLoaded', function () {
            const peopleSelect = document.getElementById('people');
            const carTypeSelect = document.getElementById('car_type');
            const carImage = document.getElementById('car_image');
            const seatSelect = document.getElementById('seat');

            const carOptions = {
                low: [
                    { value: 'f', text: '景觀車廂Ｆ - 雙人座' },
                    { value: 'd', text: '景觀車廂Ｄ - 雙人包廂' }
                ],
                high: [
                    { value: 'e', text: '景觀車廂Ｅ - 四人座' },
                    { value: 'a', text: '豪華景觀車廂Ａ - VIP 四人席' }
                ]
            };

            function updateCarOptions() {
                const peopleCount = parseInt(peopleSelect.value);

                // 清空目前的選項
                carTypeSelect.innerHTML = '';
                seatSelect.innerHTML = ''; // 清空座位選項

                if (peopleCount <= 2) {
                    carOptions.low.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        carTypeSelect.appendChild(opt);
                    });
                    carImage.setAttribute('data', '/src/assets/images/plan/F.svg'); // 更新圖片
                    // 添加座位選項
                    seatSelect.innerHTML += '<option value="f1">F1</option>';
                    seatSelect.innerHTML += '<option value="f2">F2</option>';
                    seatSelect.innerHTML += '<option value="f3">F3</option>';
                    seatSelect.innerHTML += '<option value="f4">F4</option>';
                    seatSelect.innerHTML += '<option value="f5">F5</option>';
                    seatSelect.innerHTML += '<option value="f6">F6</option>';
                    seatSelect.innerHTML += '<option value="f7">F7</option>';
                    seatSelect.innerHTML += '<option value="f8">F8</option>';
                } else {
                    carOptions.high.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        carTypeSelect.appendChild(opt);
                    });
                    carImage.setAttribute('data', '/src/assets/images/plan/E.svg'); // 更新圖片
                    // 添加座位選項
                    seatSelect.innerHTML += '<option value="e2">E2</option>';
                    seatSelect.innerHTML += '<option value="e3">E3</option>';
                    seatSelect.innerHTML += '<option value="e4">E4</option>';
                }
            }

            // 監聽人數選擇變化
            peopleSelect.addEventListener('change', updateCarOptions);

            // 初始化選項
            updateCarOptions();
        });




        //------- 計算車廂價格 ----------
        document.addEventListener('DOMContentLoaded', function () {
            const carTypeSelect = document.getElementById('car_type');
            const peopleSelect = document.getElementById('people');
            const orderPriceDisplay = document.getElementById('order_price'); // 用於顯示價格的元素

            const carData = [
                { CarriageID: 'f', Price: 2000 },
                { CarriageID: 'e', Price: 2000 },
                { CarriageID: 'd', Price: 6000 },
                { CarriageID: 'a', Price: 12000 }
            ];

            function updatePrice() {
                const selectedCarType = carTypeSelect.value;
                const peopleCount = parseInt(peopleSelect.value) || 0;

                // 找到對應的價格
                const carInfo = carData.find(car => car.CarriageID === selectedCarType);
                let totalPrice = 0;

                if (carInfo) {
                    totalPrice = (selectedCarType === 'f' || selectedCarType === 'e')
                        ? carInfo.Price * peopleCount
                        : carInfo.Price;
                }

                // 更新價格顯示在 order_price
                orderPriceDisplay.innerText = `$${totalPrice}`;
            }

            // 監聽選擇變化
            carTypeSelect.addEventListener('change', updatePrice);
            peopleSelect.addEventListener('change', updatePrice); // 當人數改變時也更新價格

            // 初始化價格顯示
            updatePrice();
        });




        // ---------- 取得甜點類型匯出甜點選項 -----------
        const dessertData =
        {
            jp: {
                ScheduleID: 1,
                DepartureDate: "2024-10-10",
                DepartureTime: "13:00",
                StopStart: "台北",
                StopEnd: "台中",
                MenuFirstID: 1,
                MenuFirst: "舒芙蕾佐時令水果",
                MenuFirstContent: "舒芙蕾, 時令水果, 日本綠茶",
                MenuFirstImg: "/src/assets/images/dessert/dessert_newDessert.jpg",
                MenuSecondID: 2,
                MenuSecond: "日式和菓子佐綠茶羊羹",
                MenuSecondContent: "日式和菓子, 綠茶羊羹, 靜岡抹茶",
                MenuSecondImg: "/src/assets/images/dessert/tripInfo_Jp02.png"
            },
            tw: {
                ScheduleID: 2,
                DepartureDate: "2024-10-11",
                DepartureTime: "13:00",
                StopStart: "台北",
                StopEnd: "台中",
                MenuFirstID: 1,
                MenuFirst: "麻薏蛋糕佐焦糖鳳梨",
                MenuFirstContent: "麻薏蛋糕, 炙烤焦糖鳳梨, 高山茶",
                MenuFirstImg: "/src/assets/images/dessert/tripInfo_Tw01.png",
                MenuSecondID: 2,
                MenuSecond: "地瓜涼菓佐高山茶糕",
                MenuSecondContent: "地瓜涼菓, 高山茶糕, 凍頂烏龍茶",
                MenuSecondImg: "/src/assets/images/dessert/tripInfo_Tw04.png"
            },
            eu: {
                ScheduleID: 2,
                DepartureDate: "2024-10-12",
                DepartureTime: "17:00",
                StopStart: "台北",
                StopEnd: "台中",
                MenuFirstID: 1,
                MenuFirst: "蒙布朗佐馬卡龍",
                MenuFirstContent: "蒙布朗, 馬卡龍, 卡布奇諾",
                MenuFirstImg: "/src/assets/images/dessert/trip_Eur.png",
                MenuSecondID: 2,
                MenuSecond: "草莓塔佐馬卡龍",
                MenuSecondContent: "草莓塔, 馬卡龍, 精品拿鐵",
                MenuSecondImg: "/src/assets/images/dessert/tripInfo_Eur04.png"
            }
        };
        // 當甜點類型改變時調用此函數
        function updateDessertInfo() {
            const dessertType = document.getElementById("dessert_type").value;
            const dessert = dessertData[dessertType];

            // 更新第一道甜點資訊
            document.getElementById("dessert_title1").innerText = dessert.MenuFirst;
            document.getElementById("dessert_content1").innerText = dessert.MenuFirstContent;
            document.getElementById("dessert_img1").src = dessert.MenuFirstImg;

            // 更新第二道甜點資訊
            document.getElementById("dessert_title2").innerText = dessert.MenuSecond;
            document.getElementById("dessert_content2").innerText = dessert.MenuSecondContent;
            document.getElementById("dessert_img2").src = dessert.MenuSecondImg;
        }

        // 監聽甜點類型的變化
        document.getElementById("dessert_type").addEventListener("change", updateDessertInfo);




        // -------------------------------------------
        // ---------- 起迄站與出發日期 ------------
        let scheduleData = []; // 宣告全局變數以儲存排程資料
        let selectedScheduleID = null; // 宣告全局變數以儲存選擇的 ScheduleID

        document.addEventListener('DOMContentLoaded', () => {
            const dessertTypeElement = document.getElementById('dessert_type');
            const dessertType = dessertTypeElement.value;
            const scheduleDessertUrl = `http://localhost:8000/getSchedules/${dessertType}`;

            // 初始獲取排程
            fetchSchedules(scheduleDessertUrl);

            // 監聽甜點類型變化
            dessertTypeElement.addEventListener('change', () => {
                const newDessertType = dessertTypeElement.value;
                const newUrl = `http://localhost:8000/getSchedules/${newDessertType}`;
                fetchSchedules(newUrl);
            });
        });

        // 獲取排程並更新 scheduleData 的函數
        function fetchSchedules(url) {
            axios.get(url)
                .then((response) => {
                    scheduleData = response.data; // 將資料存儲在全局變數中
                    console.log(scheduleData); // 顯示獲取的排程

                    // 調用以初始化日曆或更新相關 UI 元件
                    initializeCalendar();
                })
                .catch((error) => { console.log(error.response.data.message); });
        }

        // 日曆初始化函數
        function initializeCalendar() {
            const departureTimeSelect = document.getElementById('departure_time');
            const orderStartDate = document.getElementById('order_start_date');
            const orderArriveDate = document.getElementById('order_arrive_date');
            const routeStartSelect = document.getElementById('route_start');
            const routeEndSelect = document.getElementById('route_end');

            // 從 scheduleData 提取可用日期
            const availableDates = [...new Set(scheduleData.map(schedule => schedule.DepartureDate))];

            // 初始化 Flatpickr
            flatpickr("#departure_date", {
                dateFormat: "Y-m-d",
                enable: availableDates,
                disable: [
                    function (date) {
                        return !availableDates.includes(date.toISOString().split('T')[0]);
                    }
                ],
                onChange: function (selectedDates, dateStr) {
                    setDepartureDetails(dateStr);
                }
            });

            // 設置出發詳情的函數
            const setDepartureDetails = (selectedDate) => {
                const selectedTime = departureTimeSelect.value;

                // 查找匹配的排程
                const schedule = scheduleData.find(s => s.DepartureDate === selectedDate && s.DepartureTime === selectedTime);

                if (schedule) {
                    orderStartDate.textContent = `${schedule.DepartureDate} ${schedule.DepartureTime}`;
                    selectedScheduleID = schedule.ScheduleID; // 儲存選擇的 ScheduleID
                    console.log(`選擇的 Schedule ID: ${selectedScheduleID}`); // 在控制台顯示
                    updateRouteOptions(selectedDate, selectedTime);
                } else {
                    orderStartDate.textContent = "無可用排程";
                    orderArriveDate.textContent = "";
                    clearRouteOptions();
                }
            };

            // 更新路線選項的函數
            function updateRouteOptions(selectedDate, selectedTime) {
                clearRouteOptions();

                const routes = scheduleData.filter(schedule =>
                    schedule.DepartureDate === selectedDate && schedule.DepartureTime === selectedTime
                );

                console.log(routes); // 調試：檢查過濾後的排程

                // 輸出每個排程的 ScheduleID
                routes.forEach(route => {
                    console.log(`Schedule ID: ${route.ScheduleID}`);
                });

                const startRoutes = new Set();
                const endRoutes = new Set();

                routes.forEach(route => {
                    startRoutes.add(route.StartStopName);
                    endRoutes.add(route.EndStopName);
                });

                // 如果沒有可選的起站或迄站
                if (startRoutes.size === 0 && endRoutes.size === 0) {
                    console.log("沒有可選擇的起站或迄站");
                    return; // 不執行後續操作
                }

                // 更新起站選項
                startRoutes.forEach(route => {
                    routeStartSelect.innerHTML += `<option value="${route}">${route}</option>`;
                });

                // 更新迄站選項
                endRoutes.forEach(route => {
                    routeEndSelect.innerHTML += `<option value="${route}">${route}</option>`;
                });

                // 監聽迄站選擇變化
                routeEndSelect.addEventListener('change', () => {
                    const selectedRouteEnd = routeEndSelect.value;
                    const schedule = routes.find(s => s.EndStopName === selectedRouteEnd);

                    if (schedule) {
                        const arrivalTime = calculateArrivalTime(schedule.DepartureTime, schedule.Duration);
                        orderArriveDate.textContent = arrivalTime;
                    } else {
                        orderArriveDate.textContent = "";
                    }
                });
            }

            // 清空路線選項的函數
            function clearRouteOptions() {
                routeStartSelect.innerHTML = `<option value="0">請選擇站點</option>`;
                routeEndSelect.innerHTML = `<option value="0">請選擇站點</option>`;
            }

            // 計算抵達時間的函數
            function calculateArrivalTime(departureTime, duration) {
                const [hours, minutes] = departureTime.split(':').map(Number);
                const departureDateTime = new Date();
                departureDateTime.setHours(hours);
                departureDateTime.setMinutes(minutes);
                departureDateTime.setMinutes(departureDateTime.getMinutes() + duration);

                const arrivalHours = departureDateTime.getHours().toString().padStart(2, '0');
                const arrivalMinutes = departureDateTime.getMinutes().toString().padStart(2, '0');

                return `${arrivalHours}:${arrivalMinutes}`;
            }

            // 監聽出發時間和日期的變化事件
            departureTimeSelect.addEventListener('change', () => {
                const selectedDate = document.getElementById('departure_date').value;
                setDepartureDetails(selectedDate);
            });

            document.getElementById('departure_date').addEventListener('change', (event) => {
                setDepartureDetails(event.target.value);
            });
        }






        // ----------- order detail 抓客人填寫的資料 ------------
        function updateOrderDetail() {
            // 更新日期、人數
            document.getElementById("order_people").innerHTML = document.getElementById("people").value + "人";
            document.getElementById("order_start_date").innerHTML = document.getElementById("departure_date").value + " , " + document.getElementById("departure_time").value;
            let arriveTime = document.getElementById("order_arrive_date").innerHTML;

            let totalPrice = document.getElementById("order_price").innerHTML;
            // 更新座位
            let seat = document.getElementById("seat").value;
            let orderSeat;
            if (seat.startsWith('f')) {
                orderSeat = seat.replace('f', "F");
            } if (seat.startsWith('f')) {
                orderSeat = seat.replace('f', 'F');
            } else if (seat.startsWith('e')) {
                orderSeat = seat.replace('e', 'E');
            } else if (seat.startsWith('d')) {
                orderSeat = seat.replace('d', 'D');
            } else if (seat.startsWith('a')) {
                orderSeat = seat.replace('a', 'A');
            } else {
                orderSeat = seat; // 如果是其他值則原樣顯示
            }
            document.getElementById("order_seat").innerHTML = orderSeat;

            // 更新車廂類型
            let carType = document.getElementById("car_type").value;
            let orderCar;

            switch (carType) {
                case 'f':
                    orderCar = "景觀車廂Ｆ - 雙人座";
                    break;
                case 'e':
                    orderCar = "景觀車廂Ｅ - 四人座";
                    break;
                case 'd':
                    orderCar = "景觀車廂Ｄ - 雙人包廂";
                    break;
                case 'a':
                    orderCar = "豪華景觀車廂Ａ - VIP 四人席";
                    break;
                default:
                    orderCar = "";
            }

            // 將 orderCar 更新到對應的 HTML 元素
            document.getElementById("order_car").innerHTML = orderCar;

        }

        document.querySelectorAll('.form_apply select, .form_apply input, .form_seat select').forEach(element => {
            element.addEventListener('change', updateOrderDetail);
        })


        // 更新路線
        document.addEventListener('DOMContentLoaded', () => {
            const routeStart = document.getElementById("route_start");
            const routeEnd = document.getElementById("route_end");
            const orderRoute = document.getElementById("order_route");

            const updateRoute = () => {
                const start = routeStart.options[routeStart.selectedIndex].text;
                const end = routeEnd.options[routeEnd.selectedIndex].text;
                if (routeStart.value !== "0" && routeEnd.value !== "0") {
                    orderRoute.textContent = `${start} ⭢ ${end}`;
                } else {
                    orderRoute.textContent = "";
                }
            };
            routeStart.addEventListener('change', updateRoute);
            routeEnd.addEventListener('change', updateRoute);
        });






        // -------------------------------------------
        // ------- 抓客人選擇的甜點到order detail --------
        function updateOrderSummary() {
            // 取得第一道甜點的標題和數量
            const dessertTitle1 = document.getElementById("dessert_title1").innerText;
            const dessertQty1 = document.getElementById("dessert_jpA_qty").value;

            // 根據數量更新顯示的內容
            const orderDessert1 = dessertQty1 > 0 ? `${dessertTitle1} * ${dessertQty1}` : "";
            document.getElementById("order_dessert1").innerText = orderDessert1;

            // 清空第二道甜點的訂單摘要
            document.getElementById("order_dessert2").innerText = "";

            // 取得第二道甜點的標題和數量
            const dessertTitle2 = document.getElementById("dessert_title2").innerText;
            const dessertQty2 = document.getElementById("dessert_jpB_qty").value;

            // 根據數量更新顯示的內容
            // 如果 dessertQty1 被改變，這裡可以直接判斷 dessertQty2 是否大於 0
            const orderDessert2 = dessertQty2 > 0 ? `${dessertTitle2} * ${dessertQty2}` : "";
            document.getElementById("order_dessert2").innerText = orderDessert2;
        }

        // 監聽數量選擇器的變化，當數量改變時更新摘要
        document.getElementById("dessert_jpA_qty").addEventListener("change", updateOrderSummary);
        document.getElementById("dessert_jpB_qty").addEventListener("change", updateOrderSummary);






        // -------------- 甜點綁定人數 -----------------
        // 甜點綁定人數
        document.addEventListener('DOMContentLoaded', function () {
            const dessertA = document.getElementById('dessert_jpA_qty');
            const dessertB = document.getElementById('dessert_jpB_qty');
            const people = document.getElementById('people');

            function updateDessertAOptions() {
                dessertA.innerHTML = '';
                const peopleCount = parseInt(people.value) || 0;

                for (let i = 0; i <= peopleCount; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    dessertA.appendChild(option);
                }

                updateDessertBOptions();
            }

            function updateDessertBOptions() {
                const peopleCount = parseInt(people.value) || 0;
                const dessertAValue = parseInt(dessertA.value) || 0;
                const maxDessertBValue = peopleCount - dessertAValue;

                dessertB.innerHTML = '';

                for (let i = 0; i <= maxDessertBValue; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    dessertB.appendChild(option);
                }
            }

            // 監聽人數和甜點A的變化
            people.addEventListener('change', updateDessertAOptions);
            dessertA.addEventListener('change', updateDessertBOptions);

            // 初始化甜點選項
            updateDessertAOptions();
        });

        // 更新訂單摘要的函數
        function updateOrderSummary() {
            const dessertTitle1 = document.getElementById("dessert_title1").innerText;
            const dessertQty1 = parseInt(document.getElementById("dessert_jpA_qty").value) || 0;

            const orderDessert1 = dessertQty1 > 0 ? `${dessertTitle1} * ${dessertQty1}` : "";
            document.getElementById("order_dessert1").innerText = orderDessert1;

            const dessertTitle2 = document.getElementById("dessert_title2").innerText;
            const dessertQty2 = parseInt(document.getElementById("dessert_jpB_qty").value) || 0;

            const orderDessert2 = dessertQty2 > 0 ? `${dessertTitle2} * ${dessertQty2}` : "";
            document.getElementById("order_dessert2").innerText = orderDessert2;

            // 取得旅客人數
            const people = parseInt(document.getElementById("people").value) || 0;

            // 只在 dessertQty2 被選取後才進行檢查
            if (dessertQty2 > 0 && dessertQty1 + dessertQty2 !== people) {
                alert("旅客人數應等於餐點份數");
            }
        }

        // 監聽甜點A和甜點B的變化以更新訂單摘要
        document.getElementById("dessert_jpA_qty").addEventListener("change", updateOrderSummary);
        document.getElementById("dessert_jpB_qty").addEventListener("change", updateOrderSummary);




        // ---------------------------------------------------
        // -------------- 訂位資料判斷 ----------------
        function userInfoCheck(event) {

            // 取得輸入框
            const name = document.getElementById('Name');
            const phone = document.getElementById('phone');
            const email = document.getElementById('email');
            const creditCard = document.getElementById('creditCard');

            // 清除之前的錯誤信息
            document.querySelectorAll('.error').forEach(span => {
                // span.textContent = ''; // 清空文本
                span.classList.remove('active'); // 隱藏錯誤提示
            });

            let isValid = true;

            // 驗證姓名
            if (name.value.trim() === '' || name.value.length < 2) {
                const errorSpan = name.nextElementSibling;
                errorSpan.textContent = '請輸入有效姓名！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            // 驗證手機號碼
            if (!phone.value.match(/^09[0-9]{8}$/)) {
                const errorSpan = phone.nextElementSibling;
                errorSpan.textContent = '請輸入有效的手機號碼！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            // 驗證電子郵件
            if (!email.value.match(/^[^@\s]+@[^@\s]+\.[^@\s]+$/)) {
                const errorSpan = email.nextElementSibling;
                errorSpan.textContent = '請輸入有效的電子郵件！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            // 驗證信用卡號
            if (!creditCard.value.match(/^[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{4}$/)) {
                const errorSpan = creditCard.nextElementSibling;
                errorSpan.textContent = '請輸入有效的信用卡號！';
                errorSpan.classList.add('active');
                isValid = false;
            }

            // -------------- send data -------------------------------

            let sendName = document.getElementById('Name').value;
            let sendPhone = document.getElementById('phone').value;
            let sendEmail = document.getElementById('email').value;
            let sendCreditCard = document.getElementById('creditCard').value;
            let sendRoute = document.getElementById('order_route').innerText;
            let sendStartDate = document.getElementById('order_start_date').innerText;
            let sendArriveDate = document.getElementById('order_arrive_date').innerText;
            let sendPeople = document.getElementById('order_people').innerText;
            let sendCar = document.getElementById('order_car').innerText;
            let sendSeat = document.getElementById('order_seat').innerText;
            let sendDessert1 = document.getElementById('order_dessert1').innerText;
            let sendDessert2 = document.getElementById('order_dessert2').innerText;
            let sendPrice = document.getElementById('order_price').innerText;

            if (isValid) {
                console.log('輸入正確');
                console.log(sendName);
                console.log(sendPhone);
                console.log(sendEmail);
                console.log(sendCreditCard);
                console.log(sendRoute);
                console.log(sendStartDate);
                console.log(sendArriveDate);
                console.log(sendPeople);
                console.log(sendCar);
                console.log(sendSeat);
                console.log(sendDessert1);
                console.log(sendDessert2);
                console.log(sendPrice);


                let userOrderInfo = {
                    name: sendName,
                    phone: sendPhone,
                    email: sendEmail,
                    creditCard: sendCreditCard,
                    route: sendRoute,
                    date: sendStartDate,
                    arrive: sendArriveDate,
                    people: sendPeople,
                    carriage: sendCar,
                    seat: sendSeat,
                    dessert1: sendDessert1,
                    dessert2: sendDessert2,
                    price: sendPrice,
                    scheduleID: selectedScheduleID
                }

                console.log(selectedScheduleID, "ScheduleID to order");

                localStorage.setItem("dataFromUser", JSON.stringify(userOrderInfo));

                console.log(localStorage.getItem("dataFromUser"));

                window.location.href = 'order.html';
            } else {
                console.log('輸入錯誤');

            }
        };

    </script>


</body>

</html>